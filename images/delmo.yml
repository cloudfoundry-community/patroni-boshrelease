suite:
  name: dingo-postgresql
  system: docker-compose.yml
  task_service: tests

tests:
- name: read-write-replication
  spec:
  - wait: [two-nodes-running]
    assert:
    - collect-cluster-state
    - write-value-to-cluster
    - retrieve-value-from-cluster
    - replication-test

- name: failover
  spec:
  - stop: [patroni2]
    wait: [one-node-running]
    assert:
    - collect-cluster-state
    - write-value-to-cluster
  - start: [patroni2]
    wait: [two-nodes-running]
  - stop: [patroni1]
  - wait: [one-node-running]
    assert:
    - leader-has-changed
    - collect-cluster-state
    - retrieve-value-from-cluster

tasks:
- name: two-nodes-running
  command: /scripts/nodes-running 2
- name: one-node-running
  command: /scripts/nodes-running 1
- name: collect-cluster-state
  command: /scripts/collect-cluster-state
- name: replication-test
  command: /scripts/replication-test
- name: leader-has-changed
  command: /scripts/leader-has-changed
- name: write-value-to-cluster
  command: /scripts/store-value testtable test-value
- name: retrieve-value-from-cluster
  command: /scripts/retrieve-value testtable test-value
