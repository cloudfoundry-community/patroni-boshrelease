suite:
  name: dingo-postgresql
  system: docker-compose.yml
  task_service: tests

tests:
- name: read-write-replication
  spec:
  - wait: [two-nodes-running]
    assert: [collect-cluster-state]
  - assert: [basic-storage, replication]

- name: failover
  spec:
  - wait: [two-nodes-running]
  - stop: [patroni1]
    wait: [collect-cluster-state]
  - wait: [one-node-running]
  - start: [patroni1]
    wait: [collect-cluster-state]
  - wait: [two-nodes-running]
  - wait: [collect-cluster-state]
  - stop: [patroni2]
  - wait: [one-node-running]
    assert: [leader-has-changed]

tasks:
- name: two-nodes-running
  command: /scripts/nodes-running 2
- name: one-node-running
  command: /scripts/nodes-running 1
- name: collect-cluster-state
  command: /scripts/collect-cluster-state.sh
- name: basic-storage
  command: /scripts/basic-storage.sh
- name: replication
  command: /scripts/replication.sh
- name: leader-has-changed
  command: /scripts/leader-has-changed
