suite:
  name: dingo-postgresql
  system: docker-compose.yml
  task_service: tests

tests:
- name: read-write-replication-recovery
  spec:
  - assert: [purge-backups]
  - wait: [two-nodes-running]
    assert:
    - cache-cluster-state
    - write-dummy-value
    - retrieve-dummy-value
    - dummy-value-replicated
    - flush-archives
    - recreate-dummy-value-from-backups

- name: failover
  spec:
  - assert: [purge-backups]
  - stop: [patroni2]
    wait: [one-node-running]
    assert:
    - cache-cluster-state
    - write-dummy-value
  - start: [patroni2]
    wait: [two-nodes-running]
  - stop: [patroni1]
  - wait: [one-node-running]
    assert:
    - leader-has-changed
    - cache-cluster-state
    - retrieve-dummy-value

tasks:
- name: two-nodes-running
  command: /scripts/nodes-running 2
- name: one-node-running
  command: /scripts/nodes-running 1
- name: cache-cluster-state
  command: /scripts/cache-cluster-state
- name: write-dummy-value
  command: /scripts/store-value testtable test-value
- name: retrieve-dummy-value
  command: /scripts/retrieve-value testtable test-value
- name: dummy-value-replicated
  command: /scripts/check-replication testtable test-value
- name: flush-archives
  command: /scripts/switch-xlog
- name: recreate-dummy-value-from-backups
  command: /scripts/recover-value testtable test-value
- name: purge-backups
  command: /scripts/purge-backups
- name: leader-has-changed
  command: /scripts/leader-has-changed
