suite:
  name: dingo-postgresql
  system: docker-compose.yml
  task_service: tests

tests:
- name: read-write-replication
  spec:
  - wait: [two-nodes-running]
    assert:
    - collect-cluster-state
    - write-dummy-value
    - retrieve-dummy-value
    - dummy-value-replicated

- name: failover
  spec:
  - stop: [patroni2]
    wait: [one-node-running]
    assert:
    - collect-cluster-state
    - write-dummy-value
  - start: [patroni2]
    wait: [two-nodes-running]
  - stop: [patroni1]
  - wait: [one-node-running]
    assert:
    - leader-has-changed
    - collect-cluster-state
    - retrieve-dummy-value

tasks:
- name: two-nodes-running
  command: /scripts/nodes-running 2
- name: one-node-running
  command: /scripts/nodes-running 1
- name: collect-cluster-state
  command: /scripts/collect-cluster-state
- name: write-dummy-value
  command: /scripts/store-value testtable test-value
- name: retrieve-dummy-value
  command: /scripts/retrieve-value testtable test-value
- name: dummy-value-replicated
  command: /scripts/check-replication testtable test-value
- name: leader-has-changed
  command: /scripts/leader-has-changed
