---
name: broker
packages:
- dingo-postgresql-broker
- dingo-postgresql-clusterdata-backup
- ruby
- cf-cli
- python
- awscli
templates:
  bin/ctl: bin/ctl
  bin/monit_debugger: bin/monit_debugger
  bin/clusterdata_callback_backup.sh: bin/clusterdata_callback_backup.sh
  bin/clusterdata_callback_restore.sh: bin/clusterdata_callback_restore.sh
  bin/clusterdata_callback_find_by_name.sh: bin/clusterdata_callback_find_by_name.sh
  bin/backups_copy.sh: bin/backups_copy.sh
  config/broker.yml.erb: config/broker.yml
  config/backup-fog.yml.erb: config/backup-fog.yml
  data/properties.sh.erb: data/properties.sh
  helpers/ctl_setup.sh: helpers/ctl_setup.sh
  helpers/ctl_utils.sh: helpers/ctl_utils.sh

provides:
- name: servicebroker
  type: servicebroker
  properties:
  - servicebroker.username
  - servicebroker.password
  - servicebroker.port
  - servicebroker.router.hostname
  - cf.api_url
  - cf.username
  - cf.password
  - cf.skip_ssl_validation
  - backups.clusterdata.aws_access_key_id
  - backups.clusterdata.aws_secret_access_key
  - backups.clusterdata.bucket_name
  - backups.clusterdata.region
  - backups.database_storage.aws_access_key_id
  - backups.database_storage.aws_secret_access_key
  - backups.database_storage.bucket_name
  - backups.database_storage.region

consumes:
- name: etcd
  type: etcd_service
- name: cf-containers-broker
  type: cf-containers-broker

properties:
  servicebroker.username:
    description: Basic auth username for broker
    default: broker
  servicebroker.password:
    description: Basic auth password for broker

  servicebroker.port:
    description: Bind port for inbound API requests
    default: 8889

  servicebroker.router.hostname:
    description: "Hostname to advertise in binding credentials for routers (defaults to host IP)"

  backups.clusterdata.aws_access_key_id:
    description: Amazon S3 API access key
  backups.clusterdata.aws_secret_access_key:
    description: Amazon S3 API secret key
  backups.clusterdata.bucket_name:
    description: Bucket name
  backups.clusterdata.region:
    description: Amazon S3 region

  backups.database_storage.aws_access_key_id:
    description: Amazon S3 API access key
  backups.database_storage.aws_secret_access_key:
    description: Amazon S3 API secret key
  backups.database_storage.bucket_name:
    description: Bucket name
  backups.database_storage.region:
    description: Amazon S3 region

  cf.api_url:
    description: URI for Cloud Foundry API to allow lookup of user-provided service names after provisioning
  cf.username:
    description: Username for Cloud Foundry API access allow lookup of user-provided service names after provisioning
  cf.password:
    description: Username for Cloud Foundry API access allow lookup of user-provided service names after provisioning
  cf.skip_ssl_validation:
    description: Set to true if Cloud Foundry API is using self-signed SSL certificate
    default: false

  servicebroker.backends.machines:
    description: "(if not using links) Hash of {z1: backend broker hostnames:port (NOTE: also becomes permanent GUID at the moment)}"
  servicebroker.backends.username:
    description: (if not using links) basic auth username to access each HTTP cf-container-broker backend
    default: containers
  servicebroker.backends.password:
    description: (if not using links) basic auth password to access each HTTP cf-container-broker backend

  servicebroker.services:
    description: (if not using links) The CF service broker catalog of services/plans

  etcd.machines:
    description: (if not using links) hostnames for etcd servers
