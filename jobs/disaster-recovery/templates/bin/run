#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables
set -x # show commands

export PATH=$PATH:/var/vcap/packages/cf-cli/bin
export PATH=$PATH:/var/vcap/packages/jq/bin

servicebroker=<%= p("servicebroker.host") %>
<% if_p("servicebroker.port") do |port| %>
servicebroker="${servicebroker}:<%= port %>"
<% end %>
servicebroker_auth="<%= p('servicebroker.username') %>:<%= p('servicebroker.password') %>"

function restoreServiceInstance() {
  instance_id=$1
  echo deleting and restoring ${instance_id}
  curl -u ${servicebroker_auth} ${servicebroker}/v2/service_instances/${instance_id} -XDELETE
  curl -u ${servicebroker_auth} ${servicebroker}/v2/service_instances/${instance_id} -XPUT -d '{}'
}

echo "<%= p('restore.service_instance_ids').inspect %>"
<% p('restore.service_instance_ids').each do |instance_id| %>
restoreServiceInstance "<%= instance_id %>"
<% end %>

<% if_p('cf.api_endpoint', 'cf.user', 'cf.password', 'cf.org') do |cf_api_endpoint, cf_user, cf_password, cf_org| %>
<% if_p('cf.skip_ssl_verification') do %>
skip_ssl="--skip-ssl-validation "
<% end %>
cf login ${skip_ssl:-''} \
  -a <%= cf_api_endpoint %> \
  -u <%= p(cf_user) %> \
  -p <%= p(cf_password) %> \
  -o <%= p(cf_org) %>

cf curl /v2/services
<% end %>
