global
	maxconn 100
  <% if_p('haproxy.syslog') do |endpoint| %>
  log <%= endpoint %> local0
  log-send-hostname
  <% end %>

defaults
	log	global
	mode	tcp
  option tcplog
	retries 2
	timeout client 30m
	timeout connect 4s
	timeout server 30m
	timeout check 5s

listen servicebroker
  mode tcp
  bind :<%= p("servicebroker.public_port") %>
	<% p("servicebroker.machines").each_with_index do |broker, i| %>
  server leader_<%= i %> <%= broker %>:<%= p("servicebroker.port") %>
	<% end %>

{{range $index, $name := ls "/routing/allocation"}}
	{{range $member := getvs (printf "/service/%s/members/*" $name)}}
		{{$data := json $member}}
		{{if eq $data.role "master"}}
			{{/* extract ip:port from postgres://name:pw@host:port/postgres */}}
			{{$conn_addr := base (replace (index (split $data.conn_url "/") 2) "@" "/" -1)}}
listen {{$name}}
  mode tcp
  bind *:{{(printf "/routing/allocation/%s" $name | getv)}}
  server leader {{$conn_addr}}
		{{end}}
	{{end}}
{{end}}
